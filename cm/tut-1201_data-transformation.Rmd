---
title: transforming data
output: 
  github_document:
    toc: TRUE
    toc_depth: 2
bibliography: "../manage/refs.bib" 
csl: "../manage/csl/journal-of-peace-research.csl"
---

```{r 1201, echo=FALSE}
library(knitr)
opts_knit$set(root.dir = "../")
opts_chunk$set(echo = TRUE, message = FALSE, collapse = TRUE, warning = FALSE, cache = TRUE, cache.path = "tut-12-cache/01-", fig.path = "tut-12-images/01-")
```


```{r 1202, echo = FALSE}
library(tidyverse)
```



## introduction

The examples in this tutorial are borrowed from Chapter 5 of  [R for Data Science](http://r4ds.had.co.nz/) [@Grolemund2017]. I've trimmed their work to focus on a smaller set of skills, but you are welcome to to go to their website and work through the problems in more detail.  

- Install the `nycflights13` package 
- Start a new R script *tut12_data-transformation.R* in your *practiceR* directory 

```{r 1203}
library(nycflights13)
library(tidyverse)
```


The *flights* data frame contains all 336,776 flights that departed from New York City in 2013. The data comes from the [US Bureau of Transportation Statistics](https://www.transtats.bts.gov/DatabaseInfo.asp?DB_ID=120&Link=0). 

- After loading the dataset with `library(nycflights13)`, type `?flights` in your Console to see the data dictionary.  

```{r 1204}
flights
```





## filter rows with filter()

*filter()* keeps all rows that meet the criteria you set. Columns are unchanged. For example, we select all flights on January 1st with

```{r 1205}
jan1 <- filter(flights, month == 1, day == 1)

jan1
```





## comparison operators 

To filter by comparing a variable to something, R uses the standard collection of relational operators  `>`, `>=`, `<`, `<=`, `!=` (not equal), and `==` (equal)...note that the *equal* comparison has two equal signs. 


Be careful when looking for equlaity between two floating point numbers.

```{r 1206}
sqrt(2) ^ 2 == 2

1/49 * 49 == 1
```

Instead of relying on `==`, use `dplyr::near(x, y)` to compare floating point numbers `x` and `y`, 

```{r 1207}
near(sqrt(2) ^ 2,  2)

near(1 / 49 * 49, 1)
```

R includes the usual set of Boolean operators: AND `&`, OR `|`, XOR `xor()`, and NOT `!`. 


The following code finds all flights that departed in November or December:

```{r 1208}
filter(flights, month == 11 | month == 12)
```

A useful shorthand is `x %in% y`. This will select every row where x is one of the values in y. We could use it to rewrite the code above:

```{r 1209}
nov_dec <- filter(flights, month %in% c(11, 12))
```


Missing values (NA) can be found with `is.na()`, resulting in a logical output TRUE or FALSE. 

```{r 1210}
x <- NA
y <- 10

is.na(x)

is.na(y)
```

A [tibble](http://r4ds.had.co.nz/tibbles.html) is an "opinionated data frame that makes working in the tidyverse a little easier." Here we'll make a short tibble with an NA data entry. 

```{r 1211}
# make a data frame that has an NA entry
df <- tibble(x = c(1, NA, 3))
df
```

`filter()` only includes rows where its condition is TRUE; it excludes both FALSE and NA values. If you want to preserve missing values, ask for them explicitly:

```{r 1212}
# filter excludes NA values by default
filter(df, x > 1)


# filter includes NA values if you so specify
filter(df, is.na(x) | x > 1)
```

For more detail, see [Filter rows with filter()](http://r4ds.had.co.nz/transform.html#filter-rows-with-filter).
 
 

## select columns with select()

As you saw when we tidied the WHO tuberculosis data, datasets can be found that have hundreds or even thousands of variables (columns). `select()` allows us to narrow that list of variables to the ones we are interested in at the moment. `select()` drops variables not listed.

```{r 1213}
# Select columns by name
select(flights, year, month, day)
```


```{r 1214}
# Select all columns between year and day (inclusive)
select(flights, year:day)
```


```{r 1215}
# Select all columns except those from year to day (inclusive)
select(flights, -(year:day))
```


There are a number of helper functions you can use within `select()`:

- `starts_with("abc")`: matches names that begin with “abc”.
- `ends_with("xyz")`: matches names that end with “xyz”.
- `contains("ijk")`: matches names that contain “ijk”.

For more detail, see [Select columns with  select()](http://r4ds.had.co.nz/transform.html#select-columns-with-select). 




## rename a variable with rename() 

 To rename a variable but keep all other columns, use `rename()`. 

```{r 1216}
rename(flights, tail_num = tailnum)
```






## add new variables with mutate() 

`mutate()` adds new columns that are functions of existing columns.

```{r 1217}
# create a smaller dataset for this example
flights_sml <- select(flights, 
  year:day, 
  ends_with("delay"), 
  distance, 
  air_time
)

flights_sml
```

Create two new variables `gain` and `speed`, new columns added to the end of the dataset. 

```{r 1218}
# create two new variables gain and speed
mutate(flights_sml,
  gain  = arr_delay - dep_delay,
  speed = distance / air_time * 60
)
```

If you only want to keep the new variables, use `transmute()` instead of `mutate()`

```{r 1219}
transmute(flights_sml,
  gain  = arr_delay - dep_delay,
  speed = distance / air_time * 60
)
```

For more detail, see [Add new variables with mutate()](http://r4ds.had.co.nz/transform.html#add-new-variables-with-mutate). 



## group_by() and summarize() 

This pair of functions gives you the ability to summarize datasets by grouping variables, changing the unit of analysis from the complete dataset to individual groups. 

For example, if we goup the flights dat by date, we can find the mean delay by date. 

```{r 1220}
# first we group
by_day <- group_by(flights, year, month, day)

# then summarize
summarise(by_day, delay = mean(dep_delay, na.rm = TRUE))
```

`count()` is a special operation inside summarize that simplys counts observtaions (the number of rows) in a group.   

```{r 1221}
delays <- flights %>% 
  group_by(dest) %>% 
  summarise(
    count = n(),
    dist  = mean(distance,  na.rm = TRUE),
    delay = mean(arr_delay, na.rm = TRUE)
  ) %>% 
  filter(count > 20, dest != "HNL")

delays
```

Can you explain what each line above does? 

- `na.rm` argument removes missing values prior to computation 



## useful summarizing functions

Along with `count = n()` and `mean(x)`, 

- `median(x)` 
- `sd(x)` standard deviation
- `IQR(x)`  interquartile range 
- `min(x)`  and `max(x)` 
- `first(x)`, `nth(x, 2)`, `last(x)` for position
- `sum(!is.na(x))` number of non-missing values
- `n_distinct(x)` number of distinct values



For more detail, see [Grouped summaries with  summarize()](http://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise).

## exercise

Preparation 

- From the course website, download the *lotr-words-spoken.xlsx* spreadsheet.
- Create a R script *tut12_transform-data.R* in your *practiceR* folder. 


In your script, 

- read the Excel spreadsheet 
- tidy the LOTR data [@Bryan2017]
- group by race and sex 
- determine the total words spoken by group 

My answer:

```{r echo = FALSE}
source("practiceR/tut12_transforming-data.R")
```




## bibliography 

<div id="refs"></div>
  
---

[main page](../README.md)<br>
[topics page](../README-by-topic.md)




